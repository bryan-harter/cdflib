<!-- GitHub Copilot instructions for AI coding agents on the cdflib repo -->
## Quick Context

cdflib is a pure-Python library for reading and writing NASA CDF files. Key code lives in the `cdflib/` package: `cdfread.py` (reader), `cdfwrite.py` (writer), `dataclasses.py` (typed metadata), `epochs.py` (epoch conversions), `s3.py` (S3 access), and the `xarray/` helpers for conversion.

## What to know first (big picture)
- **Reader/Writer split:** `cdflib/cdfread.py` implements an object-oriented reader (`CDF`) that supports local files, HTTP(S) URLs, and `s3://` URIs. `cdflib/cdfwrite.py` is the writer with a separate `CDF` class and its own semantics.
- **Metadata types:** `cdflib/dataclasses.py` defines structured return types (e.g. `CDFInfo`, `VDRInfo`, `ADRInfo`) used across the codebase — prefer returning/consuming these rather than ad-hoc dicts.
- **Compression & versions:** Reader supports CDF v2 and v3 and handles gzip-compressed CDFs (`_gzip_wrapper.py`). Many branches in `cdfread.py`/`cdfwrite.py` depend on `self.cdfversion` and compression flags — inspect those fields when changing read/write logic.
- **Xarray integration:** `cdflib/xarray/` provides `cdf_to_xarray.py` and `xarray_to_cdf.py`. These are integration layers — changes to core types must be reflected here.

## Project workflows & commands
- Run tests locally: `pytest tests/` (project config in `setup.cfg`).
- Full tox matrix (multiple Python versions / factors): `tox -l -v` to list, then `tox -e py312` or `tox -e py312-online` to run an environment. `tox -e build_docs` builds MkDocs docs.
- CI/test command: tox sets `PYTEST_COMMAND = pytest --cov=cdflib tests/` in `tox.ini` — use it to maintain parity with CI.

## Patterns & conventions used here (concrete examples)
- **File/URL/S3 handling:** The `CDF` reader detects URI type by string prefix (`'s3://'`, `'http(s)://'`) and sets `self.ftype`. Follow this pattern for adding alternate input sources.
- **Resource lifecycle:** `cdfread.CDF` keeps an open file handle (`self._f`) and deletes temporary files in `__del__`. If adding background tasks, preserve this cleanup behaviour.
- **Encoding/majority tokens:** The code uses token helper functions (`_encoding_token`, `_major_token`) and numeric constants (see top of `cdfwrite.py` for many constants). Reuse these helpers rather than hardcoding numbers.
- **Tests that require remote data:** Some tests use `pytest-remotedata`. Use the `-online` tox factor (or `--remote-data=any` pytest flag) to run them.

## Files to inspect first for most changes
- `cdflib/cdfread.py` — primary reader (large, complex). Example: handling of `self._compressed`, `self.cdfversion` and var accessors (`varget`).
- `cdflib/cdfwrite.py` — primary writer with many constants and validation logic.
- `cdflib/dataclasses.py` — canonical shapes returned from readers/writers.
- `cdflib/epochs.py` and `epochs_astropy.py` — epoch conversions; tests rely on consistent epoch handling.
- `cdflib/s3.py` — S3 download/read helpers; changes here impact remote file support.
- `cdflib/xarray/` — conversion glue to/from xarray.

## Testing tips (practical)
- Run a single test file: `pytest tests/test_cdfread.py -q` or `pytest tests/test_cdfread.py::test_your_target -q`.
- Use tox environments when testing multiple dependency combinations: `tox -e py311,py312` or include `-online` factor for remote tests.
- Coverage: the project adds `--cov=cdflib` in pytest config; CI uses that to gate coverage metrics.

## Common pitfalls to avoid
- Modifying `cdfread.py` without updating `xarray` converters can break higher-level APIs.
- Changing dataclass fields must be coordinated with tests and xarray conversions.
- The writer and reader `CDF` classes are separate APIs; do not conflate their implementations.

## Where to update version or release metadata
- Version is generated by `setuptools-scm` and captured in `cdflib/_version.py`; do not edit it manually.

## If you need to add a new feature
- Step 1: add/update unit tests under `tests/` demonstrating expected behavior.
- Step 2: update core implementation (`cdfread.py` or `cdfwrite.py`) and `dataclasses.py` if metadata shape changes.
- Step 3: update `cdflib/xarray/*` converters if the public API or payload shape changes.
- Step 4: run `tox -e py312` and `tox -e build_docs` locally.

If any part of this summary is unclear or you'd like more detail about a specific module or workflow, tell me which section and I will expand or correct it.
